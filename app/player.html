<!DOCTYPE html>
<html>
<head>
	<title>Faux Radio Chatter Jukebox</title>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.4/howler.min.js"></script>
	<style>
		body {
			/*    background: radial-gradient(circle, #36363D 0%, black 100%); */
			background-color:black;
			background-image:url('/control_panel.jpg');
			background-repeat: no-repeat;
			background-attachment: fixed;
			background-position: center;

			color: #4DDCC8;
			font-family: monospace;
		}
		#infobox {
			border: 1px solid #242526;
			border-radius:3px;
			display:inline; width:24%;
		}

		#red_led {

				    width: 6px;
				        height: 6px;
					    border-radius: 50%;
					        background-color: #FCC;
						    box-shadow: 0 0 8px 8px #AA222277;
						        position: absolute;
							    left: 412px;
							        top: 507px;
		}
	</style>
</head>
<body>
	<div id="infobox">
		<p></p>
		<p></p>
		<p>
			need controls for frequency, volume, mood
			this part is clientside only
		</p>
		<p>
			maybe later, a form to upload
		</p>
	</div>
	<span id="red_led"></span>

	<button id="mute_button" onclick="if(g_muted){g_muted=false}else{g_muted=true};playRandomSound();">mute</button>

	<span id="transcription"></span>

	<script>
	// Some Globals
	var g_muted = true;
	var g_soundUrls = [
	  "/rdo.ogg"
	];


function isAudioPlaying() {
	  var sounds = Howler._howls;
	  for (var i = 0; i < sounds.length; i++) {
		      if (sounds[i].playing()) {
			            return true;
			          }
		    }
	  return false;
}

function playRandomSound() {
  // Get a random index from the array
  const randomIndex = Math.floor(Math.random() * g_soundUrls.length);
  const randomUrl = g_soundUrls[randomIndex];

  // Create a new Howler sound object
  const sound = new Howl({
    src: [randomUrl]
  });

  // Generate a random delay between 1 and 5 seconds (adjustable)
  const randomDelay = Math.floor(Math.random() * 16000) + 1000;

  // Play the sound with a delay
  setTimeout(function() {
    if (g_muted) {
	console.warn("Muted!");
    } else {
      if (isAudioPlaying()) { //then ONLY high pri is allowed in!
	console.warn("Audio already playing! Only Hi-Pri can get in now...");
      } else {
	      sound.play();
	      filenametext = (new URL(randomUrl)).pathname.replace(/\.ogg$/,"").replace(/[/_]/g," ");
	      console.log(filenametext);
		document.querySelector("#infobox > p").innerText = " [ " + filenametext + " ] ";
      }
      playRandomSound();
    }
  }, randomDelay);
}


async function fetchAndParseHTML(url) {
  try {
    const response = await fetch(url);
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    const htmlString = await response.text();
    const parser = new DOMParser();
    const doc = parser.parseFromString(htmlString, "text/html");
    return doc;
  } catch (error) {
    console.error("Error fetching and parsing HTML:", error);
    return null; // Or handle the error differently
  }
}


//Ok, go.
fetchAndParseHTML("/") //Root of current site. might be better to use navigator object
  .then(doc => {
    if (doc) {
      console.log("Successfully parsed document:", doc);
      // You can now access the parsed document object (doc)
      // to manipulate its content or extract information.
     doc.querySelectorAll("ul > li > a[href$='.ogg']").forEach((el)=>{
	     console.log(el.href);
	     g_soundUrls.push(el.href);
     });
	// Call the function to play a sound initially (now that we have available sounds identified)
	playRandomSound();

	// Optionally, call the function repeatedly at a set interval
	// (Uncomment the line below to play sounds every 10 seconds)
	// setInterval(playRandomSound, 12000);
    } else {
      console.log("Failed to parse the fetched document");
	   //TODO: error message and style in #infobox somewhere
    }
  })
  .catch(error => {
    console.error("Error:", error);
  });


</script>

</body>
</html>
